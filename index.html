<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      background: #f9f9f9;
    }
    .sidebar {
      width: 240px;
      background: #2c3e50;
      color: white;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    .project-list {
      flex: 1;
      overflow-y: auto;
    }
    .project-item {
      padding: 12px;
      margin-bottom: 6px;
      background: #34495e;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .project-item.active {
      background: #3498db;
      font-weight: bold;
    }
    .btn-create-project {
      margin-top: 20px;
      padding: 10px;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .content {
      flex: 1;
      padding: 30px;
      display: flex;
      flex-direction: column;
    }
    .content-editor {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .content-header {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    .nav-btn {
      padding: 10px 15px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: #555;
    }
    .nav-btn.active {
      border-bottom: 2px solid #3498db;
      font-weight: bold;
      color: #2c3e50;
    }
    textarea {
      flex: 1;
      width: 100%;
      padding: 15px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      resize: none;
      box-sizing: border-box;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-save { background: #27ae60; color: white; }
    .btn-cancel { background: #f39c12; color: black; }
    .btn-delete-project { background: #e74c3c; color: white; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>–ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã</h2>
    <div class="project-list" id="project-list"></div>
    <button class="btn-create-project" id="btn-create-project">+ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
  </div>

  <div class="content">
    <div class="content-header" id="project-title">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div class="nav-buttons">
      <button class="nav-btn active" data-section="start">üö¶ –ù–∞—á–∞—Ç—å</button>
      <button class="nav-btn" data-section="info">‚ÑπÔ∏è –ò–Ω—Ñ–æ</button>
      <button class="nav-btn" data-section="tasks">üìã –ó–∞–¥–∞—á–∏</button>
      <button class="nav-btn" data-section="ideas">üí° –ò–¥–µ–∏</button>
      <button class="nav-btn" data-section="game">üéÆ –ò–≥—Ä–∞</button>
      <button class="nav-btn" data-section="role">üßë‚Äçüíº –†–æ–ª—å</button>
      <button class="nav-btn" data-section="values">üíé –¶–µ–Ω–Ω–æ—Å—Ç–∏</button>
    </div>

    <div class="content-editor">
      <textarea id="editor" placeholder=""></textarea>
    </div>

    <div class="action-buttons">
      <button class="action-btn btn-save" id="btn-save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="action-btn btn-cancel" id="btn-cancel">‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞</button>
      <button class="action-btn btn-delete-project" id="btn-delete-project">üóë –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbytOuy3ujd3r2491dcXTK4D-JpKp_a4J61RnUw7WH5WmDVS2bfNL0zHt97YWGBjMyx-fA/exec";

    let allProjects = {};
    let activeProject = null;
    let currentSection = 'start';

    document.addEventListener('DOMContentLoaded', async () => {
      await loadAllData();
      renderProjectList();

      if (Object.keys(allProjects).length > 0) {
        setActiveProject(Object.keys(allProjects)[0]);
      } else {
        activeProject = null;
        document.getElementById('project-title').textContent = "–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤";
        document.getElementById('editor').value = "";
      }

      setupEventListeners();
    });

    async function loadAllData() {
      const url = `${SCRIPT_URL}?action=get&project=all`;
      const response = await fetch(url);
      const rawData = await response.json();
      allProjects = {};
      if (!rawData || rawData.length === 0) return;

      rawData.forEach(item => {
        let data = item.data;

        if (typeof data.start !== "string") data.start = "";
        if (typeof data.info !== "string") data.info = "";
        if (typeof data.tasks !== "string") data.tasks = "";
        if (typeof data.ideas !== "string") data.ideas = "";
        if (typeof data.game !== "string") data.game = "";
        if (typeof data.role !== "string") data.role = "";
        if (typeof data.values !== "string") data.values = "";

        allProjects[item.project_name] = data;
      });
    }

    async function saveProject(projectName) {
      const editor = document.getElementById('editor');
      const currentText = editor.value.trim();

      if (!activeProject) return;

      if (currentSection === "start") {
        allProjects[projectName].start = currentText;
      } else {
        const lines = currentText.split("\n").map(x => x.trim()).filter(x => x);
        allProjects[projectName][currentSection] = lines.join("@@");
      }

      const dataJson = JSON.stringify(allProjects[projectName]);
      const url = `${SCRIPT_URL}?action=save&project=${encodeURIComponent(projectName)}`;
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `data=${encodeURIComponent(dataJson)}`
      });
      const result = await response.json();
      if (result.status === 'success') {
        alert(`‚úÖ –ü—Ä–æ–µ–∫—Ç "${projectName}" —Å–æ—Ö—Ä–∞–Ω—ë–Ω!`);
      }
    }

    function createNewProject(name) {
      allProjects[name] = { start: '', info: '', tasks: '', ideas: '', game: '', role: '', values: '' };
      renderProjectList();
      setActiveProject(name);
    }

    function renderProjectList() {
      const list = document.getElementById('project-list');
      list.innerHTML = '';

      const names = Object.keys(allProjects);
      if (names.length === 0) return;

      names.forEach(name => {
        const div = document.createElement('div');
        div.textContent = name;
        div.className = 'project-item';
        if (name === activeProject) div.classList.add('active');
        div.onclick = () => setActiveProject(name);
        list.appendChild(div);
      });
    }

    function setActiveProject(name) {
      activeProject = name;
      document.getElementById('project-title').textContent = name;
      renderProjectList();
      updateEditorContent();
    }

    function updateEditorContent() {
      const project = allProjects[activeProject];
      const editor = document.getElementById('editor');
      if (!project) return;

      let value = '';
      if (currentSection === "start") {
        value = project.start || '';
      } else {
        value = (project[currentSection] || '').split("@@").join("\n");
      }
      editor.value = value;
    }

    function setupEventListeners() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (activeProject) {
            const editor = document.getElementById('editor');
            const text = editor.value.trim();
            if (currentSection === "start") {
              allProjects[activeProject].start = text;
            } else {
              const lines = text.split("\n").map(x => x.trim()).filter(x => x);
              allProjects[activeProject][currentSection] = lines.join("@@");
            }
          }

          document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentSection = btn.dataset.section;
          updateEditorContent();
        });
      });

      document.getElementById('btn-save').addEventListener('click', () => {
        if (!activeProject) return;
        saveProject(activeProject);
      });

      document.getElementById('btn-create-project').addEventListener('click', () => {
        const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:");
        if (name && name.trim()) {
          createNewProject(name.trim());
        }
      });

      document.getElementById('btn-delete-project').addEventListener('click', () => {
        if (!activeProject) return;
        if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç "${activeProject}"?`)) {
          delete allProjects[activeProject];
          renderProjectList();
          if (Object.keys(allProjects).length > 0) {
            setActiveProject(Object.keys(allProjects)[0]);
          } else {
            createNewProject("–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç");
          }
        }
      });

      document.getElementById('btn-cancel').addEventListener('click', () => {
        updateEditorContent();
      });
    }
  </script>
</body>
</html>
